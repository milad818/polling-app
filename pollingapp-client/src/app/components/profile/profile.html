@if (isLoading) {
  <div class="profile-card">
    <p class="loading-text">Loading profile...</p>
  </div>
} @else if (profile) {
  <div class="profile-card">
    <!-- Profile Picture -->
    <div class="profile-picture-section">
      <div class="profile-picture-wrapper">
        @if (profile.avatarUrl) {
          <img [src]="profile.avatarUrl" alt="Profile Picture" class="profile-picture" />
        } @else {
          <div class="profile-picture-placeholder">
            <span class="placeholder-icon">&#128100;</span>
          </div>
        }
      </div>
      <h3 class="profile-name">{{ profile.username }}</h3>
    </div>

    <!-- Profile Info -->
    <div class="profile-info">
      <div class="info-row">
        <span class="info-label">&#9993; Email</span>
        <span class="info-value">{{ profile.email }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">&#128221; Bio</span>
        <span class="info-value bio-text">{{ profile.bio || 'No bio yet.' }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">&#128197; Member since</span>
        <span class="info-value">{{ formatDate(profile.createdAt) }}</span>
      </div>
    </div>

    <!-- Edit Button -->
    <button class="edit-profile-btn" type="button" (click)="openEditModal()">
      &#9998; Edit Profile
    </button>
  </div>

  <!-- Edit Profile Modal -->
  @if (showEditModal) {
    <!--
      Backdrop click closes the modal. stopPropagation on the inner dialog div
      ensures bubbled clicks from inside never trigger this handler.
      Escape-key dismissal is handled by @HostListener in the component class.
    -->
    <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
    <div class="modal-overlay" (click)="cancelEdit()">
      <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
      <div class="edit-modal" (click)="$event.stopPropagation()">
        <div class="edit-modal-header">
          <h3>Edit Profile</h3>
          <button class="modal-close-btn" type="button" (click)="cancelEdit()">&times;</button>
        </div>

        <div class="edit-modal-body">
          <!-- Clickable Avatar Upload -->
          <div class="edit-picture-section">
            <div
              class="edit-picture-wrapper clickable-avatar"
              role="button"
              tabindex="0"
              aria-label="Upload avatar"
              (click)="avatarInput.click()"
              (keydown.enter)="avatarInput.click()"
            >
              @if (editAvatarUrl) {
                <img [src]="editAvatarUrl" alt="Avatar" class="edit-picture" />
              } @else {
                <div class="edit-picture-placeholder">
                  <span>&#128100;</span>
                </div>
              }
              <div class="avatar-upload-overlay">
                <span class="avatar-upload-icon">&#128247;</span>
              </div>
            </div>
            <input
              #avatarInput
              type="file"
              accept="image/*"
              hidden
              (change)="onAvatarFileSelected($event)"
            />
            <button class="change-photo-btn" type="button" (click)="avatarInput.click()">
              Click to change photo
            </button>
          </div>

          @if (editError) {
            <div class="edit-error-banner">{{ editError }}</div>
          }

          <div class="edit-form">
            <div class="form-group">
              <label for="editUsername">Username</label>
              <input id="editUsername" type="text" [(ngModel)]="editUsername" />
            </div>
            <div class="form-group">
              <label for="editBio">Bio</label>
              <textarea id="editBio" [(ngModel)]="editBio" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="edit-modal-footer">
          <button class="cancel-btn" type="button" (click)="cancelEdit()">Cancel</button>
          <button class="confirm-btn" type="button" (click)="confirmEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  }
}
