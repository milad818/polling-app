<div class="app-container">
  <h3 class="app-instruction">Below you can create and manage your own polls.</h3>
  <div class="new-poll-container">
    <h4 class="new-poll-instruction">Create Poll</h4>

    <form #pollForm="ngForm" class="new-poll-form" (ngSubmit)="createPoll()">
      <div class="new-poll-question">
        <input
          type="text"
          name="question"
          [(ngModel)]="newPoll.question"
          placeholder="Type your question..."
          required
          minlength="5"
          #question="ngModel" />
        @if (question.invalid && question.touched) {
          <div class="error-message">
            @if (question.errors?.['required']) {
              <span>Question is required.</span>
            }
            @if (question.errors?.['minlength']) {
              <span>Question must be at least 5 characters.</span>
            }
          </div>
        }
      </div>

      <div class="new-poll-options">
        @for (option of newPoll.options; track $index) {
          <div class="option-input-wrapper">
            <input
              type="text"
              [name]="'option' + $index"
              [(ngModel)]="option.optText"
              placeholder="Type your option..."
              required
              minlength="1"
              #optionInput="ngModel" />
            @if (optionInput.invalid && optionInput.touched) {
              <div class="error-message">
                <span>Option is required.</span>
              </div>
            }
          </div>
        }
      </div>

      <div class="form-buttons-container">
        <div class="left-buttons">
          <button
            type="button"
            class="remove-option-button"
            (click)="removeOption()"
            [disabled]="newPoll.options.length <= 2"
            >Remove Option</button>
          <button
            type="button"
            class="add-option-button"
            (click)="addOption()"
            [disabled]="newPoll.options.length >= 4"
            >Add Option</button>
        </div>
        <div class="right-buttons">
          <button
            type="submit"
            class="create-poll-button"
            [disabled]="pollForm.invalid">Create Poll</button>
        </div>
      </div>
    </form>
  </div>
  <h4 class="app-instruction">Available polls:</h4>
  @for(poll of polls; track poll.id){
  <div class="polls-container">
    <div class="poll-container">
      @if (isOwnPoll(poll)) {
        <button class="delete-poll-button" (click)="deletePoll(poll.id)" title="Delete poll">
          Ã—
        </button>
      }
      <div class="poll-question"> {{poll.question}} </div>
      <div class="options-list">
        @for (option of poll.options; track $index) {
        <div class="option-bar-wrapper" (click)="doVote(poll.id, $index)">
          <div class="option-bar-bg">
            <div class="option-bar-fill" [style.width.%]="getPercentage(poll, $index)"></div>
            <div class="option-bar-content">
              <span class="option-bar-text">{{ option.optText }}</span>
              <span class="option-bar-stats">{{ getPercentage(poll, $index) }}% ({{ option.voteCount }})</span>
            </div>
          </div>
        </div>
        }
      </div>
      <div class="poll-footer">
        <span class="poll-date">{{ formatDate(poll.createdAt) }}</span>
        <span class="poll-creator">{{ poll.owner?.username || 'Unknown' }}</span>
      </div>
    </div>
  </div>
  }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation) {
  <div class="modal-overlay" (click)="cancelDelete()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirm Deletion</h3>
        <button class="modal-close" (click)="cancelDelete()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this poll?</p>
        <p class="modal-warning">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-button cancel-button" (click)="cancelDelete()">Cancel</button>
        <button class="modal-button confirm-button" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
}
